var DisconnectResponse;!function(e){e[e.Disconnected=0]="Disconnected",e[e.Waiting=1]="Waiting",e[e.TimedOut=2]="TimedOut"}(DisconnectResponse||(DisconnectResponse={}));const ref="@relprefix@".replace("---","").replace(/^\//,""),pageUrl="@targetUrl@/"+ref,refCacheName="makecode;"+ref+";@pxtRelId@";function initWebappServiceWorker(){const e=-1===ref.indexOf("/"),t=[pageUrl,"@simUrl@","/arcade/semantic.js","/arcade/main.js","/arcade/pxtapp.js","/arcade/typescript.js","/arcade/marked/marked.min.js","/arcade/highlight.js/highlight.pack.js","/arcade/jquery.js","/arcade/pxtlib.js","/arcade/pxtcompiler.js","/arcade/pxtpy.js","/arcade/pxteditor.js","/arcade/pxtsim.js","/arcade/pxtembed.js","/arcade/pxtworker.js","/arcade/pxtweb.js","/arcade/blockly.css","/arcade/semantic.css","/arcade/rtlsemantic.css","/arcade/blockly/media/sprites.png","/arcade/blockly/media/click.mp3","/arcade/blockly/media/disconnect.wav","/arcade/blockly/media/delete.mp3","/arcade/vs/loader.js","/arcade/vs/base/worker/workerMain.js","/arcade/vs/basic-languages/bat/bat.js","/arcade/vs/basic-languages/cpp/cpp.js","/arcade/vs/basic-languages/python/python.js","/arcade/vs/basic-languages/markdown/markdown.js","/arcade/vs/editor/editor.main.css","/arcade/vs/editor/editor.main.js","/arcade/vs/editor/editor.main.nls.js","/arcade/vs/language/json/jsonMode.js","/arcade/vs/language/json/jsonWorker.js","/arcade/smoothie/smoothie_compressed.js","/arcade/images/Bars_black.gif","/arcade/gifjs/gif.js","/arcade/ai.2.min.js","/arcade/target.js","/arcade/music-editor/apple.png","/arcade/music-editor/burger.png","/arcade/music-editor/cake.png","/arcade/music-editor/car.png","/arcade/music-editor/cat.png","/arcade/music-editor/cherry.png","/arcade/music-editor/clam.png","/arcade/music-editor/computer.png","/arcade/music-editor/crab.png","/arcade/music-editor/dog.png","/arcade/music-editor/duck.png","/arcade/music-editor/egg.png","/arcade/music-editor/explosion.png","/arcade/music-editor/fish.png","/arcade/music-editor/ice-cream.png","/arcade/music-editor/lemon.png","/arcade/music-editor/snake.png","/arcade/music-editor/star.png","/arcade/music-editor/strawberry.png","/arcade/music-editor/taco.png","/arcade/music-editor/bass-clef.svg","/arcade/music-editor/treble-clef.svg","","/arcade/editor.js","","@targetUrl@/arcade/monacoworker.js","@targetUrl@/arcade/worker.js"],o=r(""),i=r("%2Farcade%2Fdocs%2Fstatic%2Fproviders%2Fgithub-mark.png;%2Farcade%2Fdocs%2Fstatic%2Fproviders%2Fmicrosoft-logo.svg;%2Farcade%2Fdocs%2Fstatic%2Fproviders%2Fgoogle-logo.svg;%2Farcade%2Fdocs%2Fstatic%2Fproviders%2Fclever-logo.png;%2Farcade%2Fdocs%2Fstatic%2Flogo.svg;%2Farcade%2Fdocs%2Fstatic%2Flogo.png;%2Farcade%2Fdocs%2Fstatic%2Ficons%2Ffavicon.ico;%2Farcade%2Fdocs%2Fstatic%2FMicorsoft_logo_rgb_W-white_D-square.png;%2Farcade%2Fdocs%2Fstatic%2FMicorsoft_logo_rgb_W-white_D.png;%2Farcade%2Fdocs%2Fstatic%2Fhero-gallery%2Fmultiplayer-banner.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-forest.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-forest-locked.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-zoo.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-zoo-locked.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-rockstar.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-rockstar-locked.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-jungle.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-jungle-locked.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-space.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-space-locked.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-shark.png;%2Farcade%2Fdocs%2Fstatic%2Fbadges%2Fbadge-shark-locked.png"),n=s(t.concat(i).map(e=>e.trim()).filter(e=>!!e&&0!==e.indexOf("@")));let c=!1;function s(e){const t=[];for(const o of e)-1===t.indexOf(o)&&t.push(o);return t}function r(e){const t=String.fromCharCode(64)+"cdnUrl"+String.fromCharCode(64);return s(e.split(";").map(e=>decodeURIComponent(e).replace(t,"@cdnUrl@").trim()))}self.addEventListener("install",t=>{e?(c=!0,console.log("Installing service worker..."),t.waitUntil(caches.open(refCacheName).then(e=>(console.log("Opened cache"),console.log("Caching:\n"+n.join("\n")),e.addAll(n).then(()=>e))).then(e=>e.addAll(o).catch(e=>{console.log("Failed to cache hexfiles")})).then(()=>self.skipWaiting()))):console.log("Skipping service worker install for unnamed endpoint")}),self.addEventListener("activate",t=>{e?(console.log("Activating service worker..."),t.waitUntil(caches.keys().then(e=>{const t=e.filter(e=>{const t=function(e){const t=e.split(";");return 3!==t.length?null:t[1]}(e);return null===t||t===ref&&e!==refCacheName});return Promise.all(t.map(e=>caches.delete(e)))}).then(()=>c?(c=!1,function(){const e=self;return e.clients.claim().then(()=>e.clients.matchAll()).then(e=>{e.forEach(e=>e.postMessage({type:"serviceworker",state:"activated",ref:ref}))})}()):Promise.resolve()))):console.log("Skipping service worker activate for unnamed endpoint")}),self.addEventListener("fetch",e=>{e.respondWith(async function(e){if(e.request.url.startsWith(pageUrl)){let t=e.request.url.slice(pageUrl.length);if(t.startsWith("/")&&(t=t.slice(1)),"?"===t.charAt(0)){let t;try{t=await fetch(e.request);(await caches.open(refCacheName)).put(e.request,t.clone())}catch(e){}if(t)return t;console.warn(`Unable to fetch ${e.request.url}, falling back to cache`)}}const t=await caches.match(e.request);if(t)return t;const o=fetch(e.request);return o}(e))})}function initWebUSB(){let e,t,o,i,n=0,c="idle";async function s(e){(await self.clients.matchAll()).forEach(t=>t.postMessage(e))}function r(){let t;const i=new Promise(t=>{console.log("Waiting for disconnect "+e),o=t,s({type:"serviceworker",action:"packet-io-lock-disconnect",lock:e})}),n=new Promise(o=>{t=setTimeout(()=>{console.log("Timed-out disconnect request "+e),o(DisconnectResponse.TimedOut)},5e3)});return Promise.race([i,n]).then(e=>(clearTimeout(t),o=void 0,e))}function l(e){return new Promise(t=>{setTimeout(t,e)})}self.addEventListener("message",async a=>{const b=a.data;if("serviceworkerclient"===(null==b?void 0:b.type))if("request-packet-io-lock"===b.action){if(e||(e=await function(){if(e)return Promise.resolve(e);let t;const o=new Promise(e=>{console.log("check for existing lock"),i=e,s({type:"serviceworker",action:"packet-io-status"})}),n=new Promise(e=>{t=setTimeout(()=>{console.log("Timed-out check for existing lock"),e(void 0)},1e3)});return Promise.race([o,n]).then(e=>(clearTimeout(t),i=void 0,e))}()),"granting"===c)return void await s({type:"serviceworker",action:"packet-io-lock-granted",granted:!1,lock:b.lock});console.log("Received lock request "+b.lock);const o=Date.now()-n;if(t=b.lock,o<4e3&&(c="waiting",console.log("Waiting to grant lock request "+b.lock),await l(4e3-o)),t!==b.lock)return console.log("Rejecting old lock request "+b.lock),void await s({type:"serviceworker",action:"packet-io-lock-granted",granted:!1,lock:b.lock});if(c="granting",e){let e;do{console.log("Sending disconnect request "+b.lock),e=await r(),e===DisconnectResponse.Waiting&&(console.log("Waiting on disconnect request "+b.lock),await l(1e3))}while(e===DisconnectResponse.Waiting)}console.log("Granted lock request "+b.lock),e=b.lock,await s({type:"serviceworker",action:"packet-io-lock-granted",granted:!0,lock:b.lock}),n=Date.now(),c="idle"}else"release-packet-io-lock"===b.action?(console.log("Received disconnect for "+e),e=void 0,o&&o(DisconnectResponse.Disconnected)):"packet-io-lock-disconnect"===b.action?(console.log("Received disconnect response for "+e),b.didDisconnect&&(e=void 0),o&&o(b.didDisconnect?DisconnectResponse.Disconnected:DisconnectResponse.Waiting)):"packet-io-supported"===b.action?await s({type:"serviceworker",action:"packet-io-supported",supported:!0}):"packet-io-status"===b.action&&b.hasLock&&i&&i(b.lock)})}initWebappServiceWorker(),initWebUSB();